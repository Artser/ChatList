# План реализации функции "AI-ассистент для улучшения промтов"

## 1. Общее описание

Функция позволяет пользователю улучшить свой промт с помощью одной из доступных AI-моделей (через OpenRouter-клиент) перед отправкой в несколько нейросетей. Ассистент анализирует исходный промт и возвращает:
- улучшенную версию промта
- 2–3 варианта переформулировки
- при необходимости — адаптацию промта под разные типы моделей (код, анализ, креатив)

## 2. Архитектурные изменения

### 2.1 Новый модуль `prompt_improver.py`
- **Назначение**: Инкапсулирует логику улучшения промтов
- **Функции**:
  - `improve_prompt(original_prompt: str, model_data: dict) -> dict` - основная функция улучшения, возвращает словарь с улучшенным промтом и вариантами
  - `generate_improvement_prompt(original: str, improvement_type: str = "general") -> str` - формирование промта для улучшения с учетом типа (general, code, analysis, creative)
  - `parse_improved_response(response: str) -> dict` - извлечение улучшенного промта и вариантов из ответа модели
  - `get_improvement_variants(original: str, model_data: dict) -> dict` - получение нескольких вариантов переформулировки

### 2.2 Изменения в `network.py`
- Использовать существующий OpenRouter-клиент для отправки запросов на улучшение
- Использовать существующую логику отправки запросов к API через `send_prompt_to_model`

### 2.3 Изменения в `db.py`
- Добавить таблицу `prompt_versions` для хранения истории улучшений:
  - `id` - первичный ключ
  - `original_prompt_id` - ссылка на исходный промт (опционально)
  - `improved_prompt` - улучшенная версия
  - `variants` - JSON с альтернативными вариантами
  - `improvement_type` - тип улучшения (general, code, analysis, creative)
  - `model_used` - модель, использованная для улучшения
  - `created_at` - дата создания

## 3. Интерфейс пользователя

### 3.1 Добавление кнопки "Улучшить промт"
- Расположение: рядом с полем ввода промта в вкладке "Запросы"
- Видимость: доступна только когда введен текст промта
- Стиль: выделенная кнопка для привлечения внимания

### 3.2 Диалоговое окно улучшения промта
- **Элементы интерфейса**:
  - **Верхняя панель**:
    - Поле с исходным промтом (read-only, с возможностью копирования)
    - Выпадающий список для выбора модели для улучшения (только активные модели, поддерживающие OpenRouter)
    - Выбор типа улучшения (радио-кнопки или выпадающий список):
      - Общее улучшение
      - Для кода
      - Для анализа
      - Для креатива
    - Кнопка "Улучшить"
  
  - **Область результатов** (появляется после улучшения):
    - Вкладки или секции для отображения:
      - **Улучшенный промт** (основной вариант) - редактируемое поле
      - **Вариант 1** - редактируемое поле
      - **Вариант 2** - редактируемое поле
      - **Вариант 3** (если доступен) - редактируемое поле
    - Для каждого варианта:
      - Кнопка "Подставить в поле ввода" (одним кликом)
      - Кнопка "Копировать"
  
  - **Нижняя панель**:
    - Индикатор загрузки во время обработки
    - Кнопки: "Сохранить все варианты", "Отмена"
  
  - **Дополнительные возможности**:
    - Сравнение исходного и улучшенного промта side-by-side
    - История улучшений (последние N улучшений)

### 3.3 Интеграция в основной интерфейс
- После выбора варианта промт автоматически подставляется в поле ввода
- Возможность вернуться к исходному промту через кнопку "Отменить"
- Сохранение всех вариантов в БД для последующего использования

## 4. Логика работы

### 4.1 Процесс улучшения промта

1. **Пользователь вводит промт** в основное поле ввода
2. **Нажимает кнопку "Улучшить промт"**
3. **Открывается диалоговое окно** с исходным промтом
4. **Выбирает модель** для улучшения (по умолчанию - первая активная модель, поддерживающая OpenRouter)
5. **Выбирает тип улучшения** (по умолчанию - "Общее улучшение")
6. **Нажимает "Улучшить"**
7. **Система формирует промт для улучшения** в зависимости от выбранного типа:
   - **Общее улучшение**: стандартный шаблон улучшения
   - **Для кода**: шаблон с акцентом на технические детали, структуру кода
   - **Для анализа**: шаблон с акцентом на аналитику, данные, выводы
   - **Для креатива**: шаблон с акцентом на творческий подход, оригинальность
8. **Отправляется запрос** к выбранной модели через `network.py` (OpenRouter-клиент)
9. **Полученный ответ парсится** и извлекаются:
   - улучшенная версия промта
   - 2-3 альтернативных варианта переформулировки
10. **Результаты отображаются** в соответствующих полях диалога
11. **Пользователь может**:
    - Просмотреть все варианты
    - Редактировать любой вариант вручную
    - Выбрать один вариант и подставить его в поле ввода одним кликом
    - Сохранить все варианты в БД
    - Отменить операцию

### 4.2 Формирование промта для улучшения

#### Общее улучшение:
```
Ты - эксперт по написанию эффективных промтов для AI-моделей.

Проанализируй и улучши следующий промт:
- Сделай его более четким и конкретным
- Добавь структуру, если необходимо
- Убедись, что инструкции понятны
- Оптимизируй для получения лучших результатов

Исходный промт:
{original_prompt}

Верни улучшенную версию промта и 2-3 альтернативных варианта переформулировки.
Формат ответа:
Улучшенный промт: [текст]
Вариант 1: [текст]
Вариант 2: [текст]
Вариант 3: [текст] (опционально)
```

#### Для кода:
```
Ты - эксперт по написанию промтов для генерации кода.

Улучши следующий промт для получения качественного кода:
- Уточни технические требования
- Добавь спецификацию языка программирования и стиля
- Укажи необходимые библиотеки и зависимости
- Добавь требования к структуре и документации

Исходный промт:
{original_prompt}

Верни улучшенную версию промта и 2-3 альтернативных варианта переформулировки.
Формат ответа:
Улучшенный промт: [текст]
Вариант 1: [текст]
Вариант 2: [текст]
Вариант 3: [текст] (опционально)
```

#### Для анализа:
```
Ты - эксперт по написанию промтов для аналитических задач.

Улучши следующий промт для глубокого анализа:
- Уточни тип анализа (количественный, качественный, сравнительный)
- Добавь требования к структуре вывода
- Укажи необходимые метрики и показатели
- Уточни формат представления результатов

Исходный промт:
{original_prompt}

Верни улучшенную версию промта и 2-3 альтернативных варианта переформулировки.
Формат ответа:
Улучшенный промт: [текст]
Вариант 1: [текст]
Вариант 2: [текст]
Вариант 3: [текст] (опционально)
```

#### Для креатива:
```
Ты - эксперт по написанию промтов для творческих задач.

Улучши следующий промт для максимальной креативности:
- Добавь требования к стилю и тону
- Уточни целевую аудиторию
- Добавь пожелания к оригинальности и уникальности
- Укажи формат и структуру творческой работы

Исходный промт:
{original_prompt}

Верни улучшенную версию промта и 2-3 альтернативных варианта переформулировки.
Формат ответа:
Улучшенный промт: [текст]
Вариант 1: [текст]
Вариант 2: [текст]
Вариант 3: [текст] (опционально)
```

### 4.3 Парсинг ответа модели

Алгоритм парсинга:
1. Ищем маркеры "Улучшенный промт:", "Вариант 1:", "Вариант 2:", "Вариант 3:"
2. Извлекаем текст после каждого маркера до следующего маркера или конца текста
3. Очищаем от лишних форматирований (markdown, код-блоки)
4. Удаляем префиксы и постфиксы
5. Возвращаем словарь с улучшенным промтом и вариантами

### 4.4 Обработка ошибок
- Обработка сетевых ошибок при запросе к API
- Обработка таймаутов
- Валидация ответа модели (проверка, что получен валидный текст)
- Обработка случаев, когда модель вернула меньше вариантов, чем ожидалось
- Отображение понятных сообщений об ошибках пользователю
- Fallback: если парсинг не удался, использовать весь ответ как улучшенный промт

## 5. Технические детали реализации

### 5.1 Структура данных

```python
ImprovementResult = {
    'improved': str,  # Улучшенный промт
    'variants': [     # Список альтернативных вариантов
        str,          # Вариант 1
        str,          # Вариант 2
        str           # Вариант 3 (опционально)
    ],
    'improvement_type': str,  # Тип улучшения
    'model_used': str        # Модель, использованная для улучшения
}
```

### 5.2 Интеграция с OpenRouter
- Использовать существующий `OpenRouterClient` из `network.py`
- Определять модели, поддерживающие OpenRouter, по `api_url` или `name`
- Использовать `send_prompt_to_model` для отправки запросов

### 5.3 Сохранение в БД
- При сохранении всех вариантов создавать запись в `prompt_versions`
- Сохранять варианты в формате JSON в поле `variants`
- Связывать с исходным промтом через `original_prompt_id` (если промт сохранен)

## 6. Этапы реализации

### Этап 1: Базовая функциональность
- [x] Создать модуль `prompt_improver.py` с базовой логикой
- [ ] Расширить функцию `improve_prompt` для возврата нескольких вариантов
- [ ] Реализовать формирование промта для улучшения с разными типами
- [ ] Реализовать парсинг ответа модели с извлечением вариантов
- [ ] Добавить поддержку разных типов улучшения (general, code, analysis, creative)

### Этап 2: Интерфейс
- [x] Добавить кнопку "Улучшить промт" в главное окно
- [x] Создать диалоговое окно улучшения промта (класс `PromptImprovementDialog`)
- [ ] Расширить диалог для отображения нескольких вариантов
- [ ] Добавить выбор типа улучшения (радио-кнопки или выпадающий список)
- [ ] Реализовать вкладки или секции для каждого варианта
- [ ] Добавить кнопки "Подставить в поле ввода" для каждого варианта
- [ ] Добавить индикатор загрузки

### Этап 3: Интеграция
- [x] Подключить диалог к главному окну
- [x] Реализовать подстановку улучшенного промта в поле ввода
- [ ] Реализовать подстановку выбранного варианта одним кликом
- [ ] Добавить обработку ошибок и валидацию
- [ ] Интегрировать с OpenRouter-клиентом

### Этап 4: Сохранение в БД
- [x] Добавить таблицу `prompt_versions` в `db.py`
- [ ] Реализовать сохранение всех вариантов в БД
- [ ] Добавить функцию для загрузки истории улучшений
- [ ] Добавить возможность просмотра истории в диалоге

### Этап 5: Улучшения UX
- [ ] Добавить возможность сравнения исходного и улучшенного промта side-by-side
- [ ] Реализовать отмену последнего улучшения
- [ ] Добавить кнопки "Копировать" для каждого варианта
- [ ] Добавить визуальное выделение выбранного варианта
- [ ] Оптимизировать парсинг для лучшей обработки различных форматов ответов

## 7. Примеры использования

### Сценарий 1: Простое улучшение
1. Пользователь вводит: "напиши код на Python"
2. Нажимает "Улучшить промт"
3. Выбирает модель (например, через OpenRouter)
4. Выбирает тип "Для кода"
5. Получает:
   - Улучшенный промт: "Напиши код на Python для [конкретная задача]. Код должен быть [требования]. Используй [стиль/библиотеки]."
   - Вариант 1: "Создай Python-скрипт, который [детали]. Примени [стандарты кодирования]."
   - Вариант 2: "Разработай программу на Python с [функциональностью]. Обеспечь [качество кода]."
6. Выбирает один вариант и подставляет его в поле ввода одним кликом

### Сценарий 2: Улучшение для анализа
1. Пользователь вводит: "проанализируй данные"
2. Выбирает тип "Для анализа"
3. Получает улучшенные варианты с уточнениями по метрикам, формату вывода и т.д.
4. Выбирает наиболее подходящий вариант

### Сценарий 3: Итеративное улучшение
1. Пользователь улучшает промт
2. Редактирует один из вариантов вручную
3. Снова улучшает уже отредактированную версию
4. Сохраняет финальный вариант

## 8. Дополнительные возможности (будущие улучшения)

- **Предустановленные шаблоны улучшения**: расширение типов улучшения (технический, научный, бизнес и т.д.)
- **Множественное улучшение**: использование нескольких моделей для улучшения и выбор лучшего результата
- **Анализ качества промта**: оценка промта по критериям (четкость, конкретность, структура) перед улучшением
- **История улучшений**: просмотр всех версий промта с возможностью сравнения и восстановления
- **Экспорт улучшенных промтов**: сохранение в файл для дальнейшего использования
- **Быстрые шаблоны**: предустановленные улучшения для типовых задач

## 9. Тестирование

- [ ] Unit-тесты для `prompt_improver.py`
- [ ] Тесты парсинга ответов модели с разными форматами
- [ ] Тесты для разных типов улучшения
- [ ] Интеграционные тесты с реальными API (OpenRouter)
- [ ] Тесты обработки ошибок
- [ ] UI-тесты диалогового окна
- [ ] Тесты сохранения и загрузки из БД

## 10. Документация

- [ ] Обновить документацию проекта с описанием новой функции
- [ ] Добавить примеры использования в README
- [ ] Документировать API модуля `prompt_improver.py`
- [ ] Добавить скриншоты интерфейса улучшения промтов
- [ ] Описать форматы ответов моделей для парсинга
